---
title: "SPY_RSI_stochslow_backtest"
author: "Collin"
date: "9/1/2021"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(quantmod)
library(httr)
library(jsonlite)
library(TTR)
library(zoo)
library(chron)
```




```{r}
#initialize taapi token into Renviron file
readRenviron(".Renviron")
Sys.getenv("EOD_TOKEN")
```


```{r}
#test query the API


call_received = GET(str_glue("https://cloud.iexapis.com/stable/stock/spy/chart/date/{date}?token={YOUR_TOKEN_HERE}",
             date = "20210901",                
             YOUR_TOKEN_HERE = Sys.getenv("IEX_TOKEN")))

price_data = content(call_received,type = "text") %>% 
  fromJSON()

price_data
high_low_close = price_data %>% 
  select(date,minute = label,high,low,close)







  


```

#start here
```{r}

high_low_close %>% 
  mutate(interval = rep(seq(1,n()/5), each=5)) %>% 
  group_by(interval) %>% 
  mutate(highest_high_5_days = rollmax())
 
```


#Using Alpha Vantage API
```{r}
#Call the API
stoch_call = GET(str_glue("https://www.alphavantage.co/query?function=STOCH&symbol={symbol}&interval=1min&apikey={key}&fastkperiod=14&slowdperiod=3",
                          symbol = "SPY", key = Sys.getenv("ALPHA_VANTAGE_KEY")))

stoch_call
#format properly
stochastic_data = content(stoch_call, type = "text") %>% 
  fromJSON()

stochastic_data
stochastic_data = stochastic_data$`Technical Analysis: STOCH` %>% 
  as.tibble() 
stochastic_data


p="[0-9]{4}-[0-9]{2}-[0-9]{2}"
time_extract = "\\s[0-9]{2}:[0-9]{2}"
stochastic_data = stochastic_data %>% unnest() %>% 
  mutate(stochastic = rep_len(c("SlowD", "SlowK"), length.out = 2)) %>% 
  pivot_longer(cols = -stochastic, names_to = "time", values_to = "stochastic_values") %>% 
  arrange(time) %>% 
  mutate(date = ymd_hm(time)) %>% 
  pivot_wider(names_from = stochastic,values_from = stochastic_values) %>% 
  filter(date >= "2021-09-01") %>% 
  arrange(time)



stochastic_data %>% 
  mutate(date = format(time, tz="America/Los_Angeles"))

   
 


```
#Using EOD API
```{r}
eod_call = GET(str_glue("https://www.alphavantage.co/query?function=STOCH&symbol={symbol}&interval=1min&apikey={key}&fastkperiod=14&slowdperiod=3",
                          symbol = "SPY", key = Sys.getenv("ALPHA_VANTAGE_KEY")))


```






